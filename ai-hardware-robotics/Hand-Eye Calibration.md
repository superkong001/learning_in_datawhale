### 手眼标定的定义

手眼标定（Hand-Eye Calibration）是机器人视觉应用中的一个基础且关键的问题，主要用于统一视觉系统与机器人的坐标系，具体来说，就是确定摄像头与机器人的相对姿态关系。

> 当我们希望使用视觉引导机器人去抓取物体时，需要知道三个相对位置关系，即
> 
> 1. 末端执行器与机器人底座之间相对位置关系
> 2. 摄像头与末端执行器之间相对位置关系
> 3. 物体与摄像头之间的相对位置和方向
> 
> 手眼标定主要解决其中第二个问题，即确定“手”与安装在其上“眼”之间的空间变换关系，即求解相机坐标系和机器人坐标系之间的变换矩阵。  这里的机器人末端执行器称为手，摄像头称为眼。

根据摄像头安装方式的不同，手眼标定分为两种形式：
1. 摄像头安装在机械手末端，称之为眼在手上（Eye in hand）
2. 摄像头安装在机械臂外的机器人底座上，则称之为眼在手外（Eye to hand）

### 手眼标定的数学模型

不管是眼在手上还是眼在手外，它们求解的数学方程是一样的，手眼标定的核心方程都为 $AH = HB$ 。

它表示：当机械臂从一个姿态 A 变到另一个姿态 B 时，相机看到的标定板的变化也会发生对应的变化。也就是机械臂动多少，相机看到的物体也要动相应的量。手眼标定的目标，就是求出这中间固定的“变换关系” $𝐻 = T^e_c$ 

- 𝐴：机械臂末端执行器在两次拍摄间的位姿变化；
- 𝐵：标定板在相机视角下的变化；
- 𝐻：相机与机械臂末端之间的固定关系（这是要标定的目标）。

首先定义如下坐标系：

$F_b$: **基座坐标系**(Base Frame)，固定在机械臂的底座上，是机械臂运动的全局参考坐标系。

$F_e$: **末端执行器坐标系**(End-Effector Frame)，固定在机械臂末端，比如机械爪、工具尖端等。

$F_c$: **相机坐标系**（Camera Frame），固定在相机光心处，用于视觉感知的坐标系。

$F_t$: **标定目标坐标系**（Calibration Target Frame），固定在标定目标（如棋盘格、圆点板）上。

坐标系之间的关系通常用齐次变换矩阵（刚体变换）T表示：

$$
T^i_j =
\begin{bmatrix}
R^i_j & t^i_j \\
0 & 1
\end{bmatrix}
$$

其中：
- $R^i_j$ ：3×3 旋转矩阵，描述坐标系 j 相对于 i 的旋转；
- $t^i_j$ ：3×1 平移向量，描述坐标系 j 相对于 i 的平移；
- $𝑖,𝑗$ ：分别代表起点与终点坐标系。
- $R ∈ SO(3)$ 旋转矩阵(3x3)
- $t ∈ R^{3}$ 平移向量

T的上下标表示变换是对于哪两个坐标系，例如：
- $T^e_c$：表示将相机坐标系转换到末端执行器坐标系的变换，也表示相机在末端执行器坐标系下的位姿，在眼在手上这种情形下，就是要求的目标矩阵。

在任意时刻 𝑘 ，四个坐标系间的几何关系为： $T^b_t=T^b_eT^e_cT^c_t$ ，也就是说，标定板（目标）在基座坐标系下的位置，可以由以下三段变换组合得到。


### Eye In Hand 推导核心方程（Derivation of the Core Equation）

当相机固定在机械臂末端时，相机与末端执行器之间的变换是固定的进行该类手眼标定时，会将标定板固定在一处，然后控制机械臂移动到不同位置，使用机械臂上固定的相机，在不同位置对标定板拍照，拍摄多组不同位置下标定板的照片。
当机械臂从姿态 1 移动到姿态 2 时，我们分别记录两次的位姿：

$$
(T^b_{e1}, T^{c1}_t)
(T^b_{e2}, T^{c2}_t)
$$

由于标定板与机器人底座是固定的，二者之间相对位姿关系不变，由几何关系则有：

$$T^b_t = T^b_{e1}T^{e1}_{c1}T^{c1}_{t} = T^b_{e2}T^{e2}_{c2}T^{c2}_{t}$$

| 符号                | 含义                         | 说明                |
| ----------------- | -------------------------- | ----------------- |
|  $(T^b_{e1})$        | 末端执行器在“姿态1”时的位姿（从末端到基座的变换） | 把末端坐标系下的点变换到基座坐标系 |
|  $(T^b_{e2})$        | 末端执行器在“姿态2”时的位姿            | 同上                |
|  $((T^b_{e2})^{-1})$ | 从“基座”到“末端2”的逆变换            | 即末端2坐标系相对于基座的变换   |
|  $(T^{e}_c)$         | 相机相对于末端执行器的固定变换            | 是我们要标定的“手眼矩阵”     |

其中 $(T^b_{e2})^{-1} T^b_{e1} T^{e}_c$ 等价于：

先从相机坐标系出发（在姿态1时），
- → 转到末端1坐标系（通过 $T^{e}_c$ ），
- → 再从末端1转到基座坐标系（通过 $T^{e1}_b$ ），
- → 最后从基座转回末端2坐标系（通过 $(T^b_{e2})^{-1}$ ）。

由于 $T^e_c$ 是固定的（相机固定安装在末端），即 $T^{e1}_c = T^{e2}_c = T^e_c$ ，因此定义：

- 末端的相对运动： $A=T^{e2}_{e1}=(T^b_{e2})$
 
  $A=T^{e2}_{e1}=(T^b_{e2})^{-1} T^b_{e1}$ 
- 目标在相机下的相对运动：
  $B=T^{c2}_{c1}=T^{c2}_t (T^{c1}_t)^{-1}$
- 常量刚体：相机刚性安装在末端
  $H=T^{e1}_c=T^{e2}_c=T^e_c$ 

对上述等式进行变换：

$$ 
\begin{align*}
(T^b_{e2})^{-1}T^b_{e1}T^{e1}_{c1}T^{c1}_{t} 
&= T^{e2}_{c2}T^{c2}_{t} (T^b_{e2})^{-1}T^b_{e1}T^{e1}_{c1} \\
&= T^{e2}_{c2}T^{c2}_{t}(T^{c1}_{t})^{-1} T^{e2}_{e1}T^{e1}_{c1} \\
&= T^{e2}_{c2}T^{c2}_{c1} T^{e2}_{e1}T^{e}_{c} \\
&= T^{e}_{c}T^{c2}_{c1} \\
\Rightarrow \quad A H &= H B
\end{align*}
$$

$$
(T^b_{e2})^{-1}T^b_{e1}T^{e1}_{c1}T^{c1}_{t} =T^{e2}_{c2}T^{c2}_{t} \ (T^b_{e2})^{-1}T^b_{e1}T^{e1}_{c1} =T^{e2}_{c2}T^{c2}_{t}(T^{c1}_{t})^{-1} \ T^{e2}_{e1}T^{e1}_{c1} =T^{e2}_{c2}T^{c2}_{c1} \ T^{e2}_{e1}T^{e}_{c} =T^{e}_{c}T^{c2}_{c1} \ AH = HB
$$

其中 $T^e_c$ 就是最终需要求解的 $H$ 。

$$(T^b_{e2})^{-1} T^b_{e1} T^{e}_c = T^{e}_c (T^{c2}_t (T^{c1}_t)^{-1})$$

于是得到手眼标定的标准形式：

$$A H = H B$$

### Eye To Hand

当相机固定在机械臂以外时，相机与末端执行器的相对位置会随着机械臂的运动而改变。进行该类手眼标定时，会将标定板固定在机械臂末端，然后控制机械臂拿着标定板，围绕着固定的相机拍照。为了求解的准确性，一般需要拍摄多于10组的照片。

由于此时标定板是固定在机械臂末端的，二者相对位置在拍摄不同照片时值不变，所以有：

$$T^e_t = T^{e1}bT^{b}{c}T^{c}{t1} = T^{e2}bT^{b}{c}T^{c}{t2}$$

$$ 
\begin{align*}
T^{e1}bT^{b}{c}T^{c}{t1} 
&= T^{e2}bT^{b}{c}T^{c}{t2} \ (T^{e2}b)^{-1}T^{e1}bT^{b}{c}T^{c}{t1} \\
&= T^{b}{c}T^{c}{t2} \ (T^{e2}b)^{-1}T^{e1}bT^{b}{c} \\
&= T^{b}{c}T^{c}{t2}(T^{c}{t1})^{-1} \ (T^b_{e2}T^{e1}b)T^{b}{c} \\
&= T^{b}{c}(T^{c}{t2}T^{t1}_c) \\
\Rightarrow \quad A H &= H B
\end{align*}
$$

### 求解 $AH = HB$ 

$AH = HB$ 求解方法，目前比较常用的是分步解法，即将方程组进行分解，然后利用旋转矩阵的性质，先求解出旋转，然后将旋转的解代入平移求解中，再求出平移部分。

常见的两步经典算法有将旋转矩阵转为旋转向量求解的Tsai-Lenz方法，基于旋转矩阵李群性质（李群的伴随性质）进行求解的Park方法等。



